/**
 * Imgur extension for phpBB.
 * @author Alfredo Ramos <alfredo.ramos@yandex.com>
 * @copyright 2017 Alfredo Ramos
 * @license GPL-2.0-only
 */
!function(){"use strict";const e=10485760,t=/image\/(?:jpe?g|png|gif|tiff(?:-fx)?|webp)/,r={enabled:"undefined"!=typeof Storage,local:"imgur_output_type",session:"imgur_output_list"};let n=[],i=[],a=!0;document.body.addEventListener("click",function(e){let t=document.body.querySelector("#imgur-image"),r=e.target.closest(".imgur-button");if(!t||!r)return;let n,i=r.getAttribute("data-add-output");a=null===i||"true"===i,"function"!=typeof MouseEvent?(n=document.createEvent("MouseEvent")).initEvent("click",!0,!0):n=new MouseEvent("click",{bubbles:!0,cancelable:!0}),t.dispatchEvent(n)}),document.body.addEventListener("change",function(o){let u=o.target;if(!u.matches("#imgur-image"))return;let s=document.body.querySelectorAll(".imgur-button"),l=u.files,c=new FormData;if(s.forEach(function(e){e&&e.setAttribute("disabled",!0)}),u.setAttribute("disabled",!0),l.length<=0)return;if(Array.prototype.forEach.call(l,function(r){t.test(r.type)?r.size>e?i.push(window.imgur.lang.imageTooBig.replace("{file}",r.name).replace("{size}",formatImageSize(r.size)).replace("{max_size}",formatImageSize(e))):c.append("imgur_image[]",r):i.push(window.imgur.lang.invalidMimeType.replace("{file}",r.name).replace("{type}",r.type))}),!c.has("imgur_image[]"))return i.push(window.imgur.lang.noImages),showImgurErrors(i),s.forEach(function(e){e&&e.removeAttribute("disabled")}),u.removeAttribute("disabled"),void(i=[]);r.enabled&&"null"!==window.localStorage.getItem(r.local)&&null!==window.localStorage.getItem(r.local)&&u.setAttribute("data-output-type",window.localStorage.getItem(r.local));let g={},d={};g.wrapper=document.body.querySelector("#imgur-progress-wrapper"),g.wrapper&&(g.bar=g.wrapper.querySelector("#imgur-progress"),g.label=g.wrapper.querySelector("#imgur-progress-label > code"),g.wrapper.classList.add("uploading"));const m=new XMLHttpRequest;m.upload.addEventListener("progress",function(e){if(!e.lengthComputable||!g.bar||!g.label)return;let t=e.loaded/e.total*100;g.bar.value=t,g.label.textContent=window.imgur.lang.uploadProgress.replace("{percentage}",t).replace("{loaded}",formatImageSize(e.loaded)).replace("{total}",formatImageSize(e.total)),t>=100&&setTimeout(function(){g.bar.removeAttribute("value")},500)},!1),m.addEventListener("load",function(e){try{let o=e.target.responseText;if(!isJSON(o)&&200!==e.target.status)return void i.push("HTTP "+e.target.status+" - "+e.target.statusText);if(o.length<=0)return void i.push(window.imgur.lang.emptyResponse);if(d=JSON.parse(o),Object.keys(d).length<=0)return void i.push(window.imgur.lang.emptyResponse);if(200!==e.target.status)return Array.isArray(d)?d.forEach(function(e){e&&i.push(e.message)}):i.push(d.message),void i.push(e.target.statusText);d.forEach(function(e){if(!e)return;let t={},i="",o={link:"",thumbnail:""};if(o.link=e.link,o.link.length>0){let e="."+o.link.split(".").pop(),t=u.getAttribute("data-thumbnail-size").trim()||"t";o.thumbnail=o.link.replace(e,t+e)}t.text=o.link,t.url="[url]"+o.link+"[/url]",t.image="[img]"+o.link+"[/img]",t.thumbnail="[url="+o.link+"][img]"+o.thumbnail+"[/img][/url]",r.enabled&&(n=Object.entries(t),window.sessionStorage.setItem(r.session,JSON.stringify(n)));let s=getOutputType(r);t.hasOwnProperty(s)?t[s].length>0&&(i=t[s]):(u.setAttribute("data-output-type","image"),window.localStorage.setItem(r.local,"image"),document.body.querySelectorAll(".imgur-output-select").forEach(function(e){if(!e)return;let t;e.value="image","function"!=typeof Event?(t=document.createEvent("Event")).initEvent("change",!0,!0):t=new Event("change",{bubbles:!0,cancelable:!0}),e.dispatchEvent(t)}),i=t.image),a&&insert_text(i)})}catch(t){i.push(t.message)}showImgurErrors(i)}),m.addEventListener("error",function(e){try{let r=e.target.responseText;if(r.length<=0)return void i.push(window.imgur.lang.emptyResponse);if(d=JSON.parse(r),Object.keys(d).length<=0)return void i.push(window.imgur.lang.emptyResponse);Array.isArray(d)?d.forEach(function(e){e&&i.push(e.message)}):i.push(d.message)}catch(t){i.push(t.message)}showImgurErrors(i)}),m.addEventListener("loadend",function(){try{fillOutputFields(n)}catch(e){i.push(e.message)}showImgurErrors(i),s.forEach(function(e){e&&e.removeAttribute("disabled")}),u.removeAttribute("disabled"),g.wrapper&&(g.wrapper.classList.remove("uploading"),g.bar&&g.bar.removeAttribute("value")),i=[]}),m.open("POST",u.getAttribute("data-ajax-action").trim(),!0),m.setRequestHeader("X-Requested-With","XMLHttpRequest"),m.setRequestHeader("Cache-Control","no-cache"),m.send(c)}),document.body.addEventListener("contextmenu",function(e){let t=e.target.closest(".imgur-wrapper");if(!t)return;let r=t.querySelector(".imgur-output-select");r&&(e.preventDefault(),r.classList.toggle("select"),r.focus())}),document.body.addEventListener("change",function(e){let t=e.target;if(!t.matches(".imgur-output-select"))return;let n=document.body.querySelector("#imgur-image"),i=t.value.trim();!n||i.length<=0||(n.setAttribute("data-output-type",i),r.enabled&&window.localStorage.setItem(r.local,i))}),document.body.addEventListener("click",function(e){if(!e.target.matches(".select")){let t=e.target.closest(".imgur-output-select");if(!t)return;t.classList.toggle("select",!t.classList.contains("select"))}}),document.body.addEventListener("click",function(e){let t=e.target.closest(".imgur-output-paste");if(!t)return;let r=t.parentNode.querySelector(".imgur-output-field");if(!r)return;let n=r.value.trim();n.length<=0||insert_text(n)}),document.body.addEventListener("change",function(e){let t=e.target;if(!t.matches(".imgur-output-field"))return;let r=t.closest("dl"),n="hidden";r.classList.toggle(n,t.value.trim().length<=0&&!r.classList.contains(n))}),window.phpbb.resizeTextArea(jQuery(".imgur-output-field"));try{if(r.enabled){let e=getOutputType(r);"null"!==window.sessionStorage.getItem(r.session)&&null!==window.sessionStorage.getItem(r.session)&&(document.body.querySelectorAll(".imgur-output-select").forEach(function(t){if(!t)return;let r,n=t.querySelector('[value="'+e+'"]');n&&(n.selected=!0,"function"!=typeof Event?(r=document.createEvent("Event")).initEvent("change",!0,!0):r=new Event("change",{bubbles:!0,cancelable:!0}),n.dispatchEvent(r))}),document.body.querySelectorAll("#imgur-panel .imgur-output-field").length<=0&&window.sessionStorage.removeItem(r.session),n=n.concat(JSON.parse(window.sessionStorage.getItem(r.session)))),fillOutputFields(n)}}catch(o){i.push(o.message)}showImgurErrors(i)}();
